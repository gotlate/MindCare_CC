<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindCare - Assessment Result</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="main-container">
        <div class="result-card" id="result-card">
            <div class.result-header">
                <i id="result-icon" class="fas"></i>
                <h2 class="section-title" style="margin-bottom: 20px;">Your Result</h2>
            </div>
            
            <div class="gauge-display">
                <svg width="250" height="250" viewBox="0 0 120 120" class="gauge-svg">
                    <circle class="gauge-base" cx="60" cy="60" r="54" fill="none" stroke-width="12"></circle>
                    <circle id="gauge-progress" class="gauge-progress" cx="60" cy="60" r="54" fill="none" stroke-width="12" transform="rotate(-90 60 60)"></circle>
                </svg>
                <div class="gauge-text">
                    <div id="animated-score" class="risk-score">0</div>
                    <div class="risk-category">{{ risk_category }}</div>
                </div>
            </div>

            <div class="result-message">
                <p>{{ message }}</p>
            </div>

            <div class="breakdown-section">
                <h3>Risk Factors Breakdown</h3>
                <p class="chart-subtitle">This chart shows the factors that had the biggest impact on your score.</p>
                <div class="chart-container">
                    <canvas id="feature-chart"></canvas>
                </div>
            </div>

            <div class="button-group">
                {% if user_type == 'professional' %}
                    <a href="{{ url_for('professional_resources_page') }}" class="button primary">Explore Resources</a>
                {% else %}
                    <a href="{{ url_for('student_resources_page') }}" class="button primary">Explore Resources</a>
                {% endif %}
                <a href="{{ url_for('index') }}" class="button secondary">Back to Home</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const riskScore = parseFloat("{{ risk_score }}");
            const riskCategory = "{{ risk_category }}";
            const featureContributions = JSON.parse('{{ feature_contributions | safe }}');
            
            // --- New Chart Logic ---
            // 1. Filter out zero-contribution features and sort by absolute impact
            const sortedFeatures = Object.entries(featureContributions)
                .filter(([key, value]) => Math.abs(value) > 0.001) // Ignore negligible values
                .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]));

            // 2. Prepare data for the chart
            const labels = sortedFeatures.map(item => item[0].replace(/_/g, ' '));
            const data = sortedFeatures.map(item => item[1]);
            
            // 3. Create dynamic background colors based on contribution
            const backgroundColors = data.map(value => value > 0 ? 'rgba(244, 67, 54, 0.7)' : 'rgba(76, 175, 80, 0.7)');
            const borderColors = data.map(value => value > 0 ? 'rgba(244, 67, 54, 1)' : 'rgba(76, 175, 80, 1)');

            const ctx = document.getElementById('feature-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Impact on Risk Score',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: 10,
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 12,
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const prefix = value > 0 ? 'Increases risk by' : 'Decreases risk by';
                                    return `${prefix}: ${Math.abs(value).toFixed(3)}`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutCubic'
                    }
                }
            });
            // --- End of New Chart Logic ---

            // (The rest of the gauge animation script remains the same)
            const resultCard = document.getElementById('result-card');
            const resultIcon = document.getElementById('result-icon');
            const animatedScore = document.getElementById('animated-score');
            const gaugeProgress = document.getElementById('gauge-progress');
            const radius = gaugeProgress.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            gaugeProgress.style.strokeDasharray = circumference;
            function setProgress(percent) {
                const offset = circumference - (percent / 10) * circumference;
                gaugeProgress.style.strokeDashoffset = offset;
            }
            setProgress(0);
            let colorClass = 'low-risk';
            let iconClass = 'fa-check-circle';
            if (riskCategory === 'Medium Risk') {
                colorClass = 'medium-risk';
                iconClass = 'fa-exclamation-triangle';
            } else if (riskCategory === 'High Risk') {
                colorClass = 'high-risk';
                iconClass = 'fa-times-circle';
            }
            resultCard.classList.add(colorClass);
            resultIcon.classList.add(iconClass);
            let startTimestamp = null;
            const duration = 1500;
            function animate(timestamp) {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentScore = progress * riskScore;
                animatedScore.textContent = currentScore.toFixed(1);
                setProgress(currentScore);
                if (progress < 1) {
                    window.requestAnimationFrame(animate);
                } else {
                    animatedScore.textContent = riskScore.toFixed(1);
                    setProgress(riskScore);
                }
            }
            window.requestAnimationFrame(animate);
        });
    </script>
</body>
</html>
